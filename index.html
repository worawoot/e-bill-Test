<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียน MWA e-Bill</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
    /* ตั้งค่า Font ให้เป็น IBM Plex Sans Thai */
    body {
        font-family: 'IBM Plex Sans Thai', sans-serif !important;
        font-weight: 600 !important;
    }
        
    /* Custom style สำหรับ Checkbox */
    .form-checkbox:checked {
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }        
    </style>
    
</head>
<body class="bg-slate-100 min-h-screen">

<div id="loadingOverlay" class="loading-overlay">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
    <p id="loadingText" class="text-gray-600 font-semibold">กรุณารอสักครู่...</p>
</div>
    
<div class="max-w-md m-auto p-2">
        <form>
            <div class="bg-white rounded-lg p-10 shadow-md"> 

                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-blue-600">ลงทะเบียน MWA e-Bill</h1>                    
                </div>
                
                <div class="mb-5 text-center">
                    <div class="mx-auto w-36 h-36 mb-4 relative">
                        <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" 
                             alt="Profile Image" 
                             id="preview" 
                             class="w-36 h-36 object-cover rounded-full border-4 border-white shadow-lg mx-auto bg-slate-100">
                    </div>

                    <div id="displayName" class="text-xl text-slate-700 font-bold mt-3 mb-2"></div>
                    
                    <label for="file" class="cursor-pointer inline-flex justify-between items-center p-2 rounded-lg text-slate-800 bg-slate-100 hover:bg-slate-300 hidden">
                        อัพโหลดรูป
                        <input type="file" id="file" name="file" accept="image/*" class="hidden">
                    </label>
                    <div class="mx-auto w-48 text-slate-500 text-xs text-center mt-1 hidden">คลิกเพื่ออัพโหลดรูปของคุณ</div>                     
                </div>
                
                <div class="flex flex-col">            
                <div class="mb-4">
                    <input type="text" class="hidden" id="userlineId" placeholder="lineId" name="userlineId" readonly>
                </div>

                <div class="mb-4">
                    <label for="keynumber3Id" class="block text-sm font-semibold text-gray-700 mb-2">ทะเบียนผู้ใช้น้ำ <span style="color: #f90202">*</span></label>
                    <input type="text" class="input-field w-full border border-slate-300 p-2 text-md rounded-lg" id="keynumber3Id" placeholder="กรอกทะเบียนผู้ใช้น้ำ 8 หลัก" name="keynumber3Id" required>
                </div>
                    
                <div class="mb-4">
                    <label for="nameId" class="block text-sm font-semibold text-gray-700 mb-2">ชื่อ-นามสกุล <span style="color: #f90202">*</span></label>
                    <input type="text" class="input-field w-full border border-slate-300 p-2 text-md rounded-lg" id="nameId" placeholder="กรอกชื่อและนามสกุล" name="nameId" required>
                </div>
                    
                <div class="mb-4">
                    <label for="keynumberId" class="block text-sm font-semibold text-gray-700 mb-2">เบอร์โทรศัพท์ (10 หลัก) <span style="color: #f90202">*</span></label>
                    <input type="tel" class="input-field w-full border border-slate-300 p-2 text-md rounded-lg" id="keynumberId" placeholder="เช่น 0812345678" pattern="^0\d{9}$" title="กรุณากรอกเบอร์โทรศัพท์ 10 หลัก ที่ขึ้นต้นด้วย 0" name="keynumberId" maxlength="10" inputmode="numeric" required>
                </div>
                    
                <div class="mb-6">
                    <label for="keynumber2Id" class="block text-sm font-semibold text-gray-700 mb-2">E-mail </label>
                    <input type="email" class="input-field w-full border border-slate-300 p-2 text-md rounded-lg" id="keynumber2Id" placeholder="example@mail.com" name="keynumber2Id" >
                </div>

                <div class="mb-6 space-y-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        เลือกประเภทเอกสารที่ต้องการรับ (e-Service) <span style="color: #f90202">*</span>
                    </label>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="keynumber4Id" name="keynumber4Id"
                            class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked>
                        <label for="keynumber4Id" class="ml-2 block text-sm font-semibold text-gray-700">
                            ใบแจ้งค่าน้ำประปา (e-Bill)
                        </label>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="keynumber5Id" name="keynumber5Id"
                            class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked>
                        <label for="keynumber5Id" class="ml-2 block text-sm font-semibold text-gray-700">
                            ใบกำกับภาษี (e-Tax Invoice)
                        </label>
                    </div>
                </div>
                    
                </div>
                <button type="button" id="submitBtn" class="bg-blue-500 text-center w-full text-white py-4 px-4 rounded-lg hover:bg-blue-700">ส่งข้อมูลลงทะเบียน</button>
                
                <footer class="text-center text-sm text-gray-600 mt-8">Copyright © 2025 WORAWOOT PHAENGPETCH</footer>
            </div>          
            
        </form>
</div>
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>

const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzKKmAmPlOXxSeALUDe3fr3YLBYXCwEwfNoJbJelKUeg-kvQcQpID7M0qPHVXIN0aUc/exec'; 
const LIFF_ID = '1657790891-40VQpd6O';

const DEFAULT_AVATAR = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";

let url = `${WEB_APP_URL}`;
let fileInput = document.getElementById("file");
let imgPreview = document.getElementById("preview");
let userlineIdInput = document.getElementById("userlineId");
let nameIdInput = document.getElementById("nameId");
let keynumberIdInput = document.getElementById("keynumberId");
let keynumber2IdInput = document.getElementById("keynumber2Id");
let submitBtn = document.getElementById("submitBtn");
let keynumber3IdInput = document.getElementById("keynumber3Id");
let keynumber4IdInput = document.getElementById("keynumber4Id");
let keynumber5IdInput = document.getElementById("keynumber5Id");

const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');

let currentProfileImage = DEFAULT_AVATAR;

window.onload = function () {
    loadingText.innerText = "กำลังโหลดข้อมูลสมาชิก...";
    loadingOverlay.style.display = 'flex';
    initializeLiff();
};

async function initializeLiff() {
    try {
        await liff.init({ liffId: `${LIFF_ID}` });
        if (liff.isLoggedIn()) {
            await getUserProfile();
        } else {
            liff.login();
        }
    }catch (err) {
        console.error('LIFF Init failed', err);
        loadingOverlay.style.display = 'none';
        Swal.fire('Error', 'ไม่สามารถเชื่อมต่อกับ LINE ได้', 'error');
    }
}

async function getUserProfile() {
    try {
        const profile = await liff.getProfile();
        document.getElementById('userlineId').value = profile.userId;

        if (profile.displayName) {
            document.getElementById('displayName').innerText = profile.displayName;
        }

        if (profile.pictureUrl) {
            currentProfileImage = profile.pictureUrl;
            imgPreview.src = currentProfileImage;
        }
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึงข้อมูลโปรไฟล์:', error);
    } finally {
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 500);
    }
}

// --- START: ส่วนที่แก้ไข Flex Message ใหม่ ---
async function sendFlexMessage() {

    if (!liff.isInClient()) {
        console.warn('Cannot send message: Not in LINE Client (External Browser)');
        return; 
    }

    // Logic การแสดงผล Badge สถานะ
    const isBill = keynumber4IdInput.checked;
    const textBill = isBill ? 'สมัครใช้บริการ' : 'ไม่สมัคร';
    const colorBillText = isBill ? '#1DB446' : '#aaaaaa';
    const colorBillBg = isBill ? '#E8F7EC' : '#f0f0f0';

    const isTax = keynumber5IdInput.checked;
    const textTax = isTax ? 'สมัครใช้บริการ' : 'ไม่สมัคร';
    const colorTaxText = isTax ? '#1DB446' : '#aaaaaa';
    const colorTaxBg = isTax ? '#E8F7EC' : '#f0f0f0';

    // จัด Format เบอร์โทรศัพท์ (081-234-5678) เพื่อความสวยงาม
    let rawPhone = keynumberIdInput.value;
    let formattedPhone = rawPhone.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');

    const flexMessage = {
      "type": "flex",
      "altText": "ลงทะเบียนสำเร็จ: MWA e-Bill",
      "contents": {
        "type": "bubble",
        "size": "mega",
        "header": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "box",
              "layout": "vertical",
              "contents": [
                {
                  "type": "text",
                  "text": "✔",
                  "size": "3xl",
                  "color": "#ffffff",
                  "align": "center"
                }
              ],
              "backgroundColor": "#32CD32",
              "cornerRadius": "100px",
              "width": "60px",
              "height": "60px",
              "justifyContent": "center",
              "margin": "md"
            },
            {
              "type": "text",
              "text": "ลงทะเบียนสำเร็จ",
              "weight": "bold",
              "size": "xl",
              "color": "#ffffff",
              "margin": "md"
            },
            {
              "type": "text",
              "text": "ระบบได้รับข้อมูลของท่านแล้ว",
              "color": "#ffffffcc",
              "size": "xs"
            }
          ],
          "backgroundColor": "#00C2F3",
          "paddingAll": "xxl",
          "alignItems": "center"
        },
        "body": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "image",
                  "url": "https://firebasestorage.googleapis.com/v0/b/webapp-c8c38.appspot.com/o/th-full-white.png?alt=media&token=88a41cdb-27fd-4c98-8d11-a390ef103163",
                  "size": "xxs",
                  "aspectMode": "fit",
                  "flex": 0
                },
                {
                  "type": "text",
                  "text": "การประปานครหลวง (สาขาลาดพร้าว)",
                  "weight": "bold",
                  "size": "xs",
                  "color": "#999999",
                  "align": "end",
                  "gravity": "center",
                  "flex": 1
                }
              ],
              "margin": "none"
            },
            {
              "type": "separator",
              "margin": "lg"
            },
            {
              "type": "text",
              "text": "ข้อมูลผู้ลงทะเบียน",
              "weight": "bold",
              "size": "sm",
              "color": "#00C2F3",
              "margin": "lg"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "ทะเบียนผู้ใช้น้ำ",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 2
                },
                {
                  "type": "text",
                  "text": keynumber3IdInput.value, 
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 3,
                  "weight": "bold"
                }
              ],
              "margin": "md"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "ชื่อ-สกุล",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 1
                },
                {
                  "type": "text",
                  "text": nameIdInput.value,
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 2,
                  "weight": "bold"
                }
              ],
              "margin": "sm"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "เบอร์โทรศัพท์",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 1
                },
                {
                  "type": "text",
                  "text": formattedPhone,
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 2,
                  "weight": "bold"
                }
              ],
              "margin": "sm"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "อีเมล",
                  "size": "sm",
                  "color": "#555555",
                  "flex": 1
                },
                {
                  "type": "text",
                  "text": keynumber2IdInput.value || '-',
                  "size": "xs",
                  "color": "#111111",
                  "align": "end",
                  "flex": 3,
                  "wrap": true,
                  "weight": "bold"
                }
              ],
              "margin": "sm"
            },
            {
              "type": "separator",
              "margin": "lg"
            },
            {
              "type": "text",
              "text": "สถานะการสมัคร",
              "weight": "bold",
              "size": "sm",
              "color": "#00C2F3",
              "margin": "lg"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "MWA e-Bill",
                  "size": "sm",
                  "color": "#555555",
                  "gravity": "center",
                  "flex": 2
                },
                {
                  "type": "box",
                  "layout": "vertical",
                  "contents": [
                    {
                      "type": "text",
                      "text": textBill,
                      "size": "xs",
                      "color": colorBillText,
                      "align": "center",
                      "weight": "bold"
                    }
                  ],
                  "backgroundColor": colorBillBg,
                  "cornerRadius": "md",
                  "paddingAll": "xs",
                  "flex": 2
                }
              ],
              "margin": "md",
              "alignItems": "center"
            },
            {
              "type": "box",
              "layout": "horizontal",
              "contents": [
                {
                  "type": "text",
                  "text": "e-Tax Invoice",
                  "size": "sm",
                  "color": "#555555",
                  "gravity": "center",
                  "flex": 2
                },
                {
                  "type": "box",
                  "layout": "vertical",
                  "contents": [
                    {
                      "type": "text",
                      "text": textTax,
                      "size": "xs",
                      "color": colorTaxText,
                      "align": "center",
                      "weight": "bold"
                    }
                  ],
                  "backgroundColor": colorTaxBg,
                  "cornerRadius": "md",
                  "paddingAll": "xs",
                  "flex": 2
                }
              ],
              "margin": "sm",
              "alignItems": "center"
            }
          ],
          "paddingBottom": "xl"
        },
        "footer": {
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "text",
              "text": "ขอบคุณที่ใช้บริการ MWA",
              "size": "xs",
              "color": "#aaaaaa",
              "align": "center"
            }
          ],
          "backgroundColor": "#ffffff"
        },
        "styles": {
          "footer": {
            "separator": true
          }
        }
      }
    };

    try {
        await liff.sendMessages([flexMessage]);
        console.log("Flex message sent");
    } catch (error) {
        console.error("Error sending flex message:", error); 
    }
}
// --- END: จบส่วนแก้ไข Flex Message ---

function getBase64(file) {
    return new Promise((resolve, reject) => {
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

function previewImage() {
    if (fileInput.files.length > 0) {
        let file = fileInput.files[0];
        let reader = new FileReader();
        reader.onload = function(e) {
            imgPreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        imgPreview.src = currentProfileImage;
    }
}

fileInput.addEventListener('change', () => {
    previewImage();
});

function validateForm() {
    const userlineId = userlineIdInput.value.trim();
    const nameId = nameIdInput.value.trim();
    const keynumberId = keynumberIdInput.value.trim();
    const keynumber3Id = keynumber3IdInput.value.trim();
    const keynumber4Id = keynumber4IdInput.value.trim();
    const keynumber5Id = keynumber5IdInput.value.trim();

    if (userlineId === '' || nameId === '' || keynumberId === '' || keynumber3Id === '' || keynumber4Id === '' || keynumber5Id === '') {
        return false;
    }
    return true;
}

async function showConfirmationDialog() {
    const confirmation = await Swal.fire({
        title: 'ยืนยันการส่งข้อมูล',
        text: 'ตรวจสอบความถูกต้องก่อนส่งข้อมูล?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'แก้ไข',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
    });
    return confirmation.isConfirmed;
}

submitBtn.addEventListener('click', async (event) => {
    event.preventDefault();

    if (!validateForm()) {
        Swal.fire({
            icon: 'warning',
            title: 'ข้อมูลไม่ครบถ้วน',
            text: 'กรุณากรอกข้อมูลในช่องที่มีเครื่องหมาย * ให้ครบ',
        });
        return;
    }

    const keynumber3Val = keynumber3IdInput.value.trim();
    if (!/^\d{8}$/.test(keynumber3Val)) {
        Swal.fire({
            icon: 'warning',
            title: 'ข้อมูลไม่ถูกต้อง',
            text: 'กรุณากรอกทะเบียนผู้ใช้น้ำเป็นตัวเลข 8 หลักเท่านั้น',
        });
        return;
    }

    const keynumberVal = keynumberIdInput.value.trim();
    if (!/^0\d{9}$/.test(keynumberVal)) {
        Swal.fire({
            icon: 'warning',
            title: 'เบอร์โทรศัพท์ไม่ถูกต้อง',
            text: 'กรุณากรอกเบอร์โทรศัพท์ 10 หลัก ให้ถูกต้อง (ตัวเลขเท่านั้นและขึ้นต้นด้วย 0)',
        });
        return;
    }
    
    const isConfirmed = await showConfirmationDialog();

    if (isConfirmed) {
        submitBtn.disabled = true;
        loadingText.innerText = "กำลังบันทึกข้อมูล...";
        loadingOverlay.style.display = 'flex';      

        try {
            let obj;             
            if (fileInput.files.length > 0) {               
                let file = fileInput.files[0];
                let base64 = await getBase64(file);
                imgPreview.src = `data:${file.type};base64,${base64}`;

                obj = {
                    base64: base64,
                    type: file.type,
                    name: file.name,
                    userlineId: userlineIdInput.value,
                    nameId: nameIdInput.value,
                    keynumberId: keynumberIdInput.value,
                    keynumber3Id: keynumber3IdInput.value,
                    keynumber4Id: keynumber4IdInput.checked,
                    keynumber5Id: keynumber5IdInput.checked
                };
            } else {
                let imageUrlToFetch = currentProfileImage;
                let imageName = "Profile.jpg";
                
                try {
                    let response = await fetch(imageUrlToFetch);
                    let blob = await response.blob();
                    let base64 = await getBase64(blob);
                    
                    obj = {
                        base64: base64,
                        type: blob.type,
                        name: imageName,
                        userlineId: userlineIdInput.value,
                        nameId: nameIdInput.value,
                        keynumberId: keynumberIdInput.value,
                        keynumber2Id: keynumber2IdInput.value,
                        keynumber3Id: keynumber3IdInput.value,
                        keynumber4Id: keynumber4IdInput.checked,
                        keynumber5Id: keynumber5IdInput.checked
                    };
                } catch (corsError) {
                    console.warn("Cannot fetch Profile Image due to CORS, using Default Avatar instead.");
                    let response = await fetch(DEFAULT_AVATAR);
                    let blob = await response.blob();
                    let base64 = await getBase64(blob);

                    obj = {
                        base64: base64,
                        type: "image/png",
                        name: "Avatar.png",
                        userlineId: userlineIdInput.value,
                        nameId: nameIdInput.value,
                        keynumberId: keynumberIdInput.value,
                        keynumber2Id: keynumber2IdInput.value,
                        keynumber3Id: keynumber3IdInput.value,
                        keynumber4Id: keynumber4IdInput.checked,
                        keynumber5Id: keynumber5IdInput.checked
                    };
                }
            }

            let response = await fetch(url, {
                method: "POST",
                body: JSON.stringify(obj)
            });

            await response.text(); 
            await sendFlexMessage();

            loadingOverlay.style.display = 'none';  

            await Swal.fire({
                title: 'สำเร็จ!',
                text: 'ส่งข้อมูลลงทะเบียนเรียบร้อย',
                icon: 'success',
                confirmButtonText: 'ปิดหน้าต่าง',
                allowOutsideClick: false
            });

            liff.closeWindow();

        } catch (error) {
            loadingOverlay.style.display = 'none';
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: 'ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่ภายหลัง',
            });
            submitBtn.disabled = false;
        } 
  }
});
</script>
</body>
</html>
